# Segment - Customer Data Platform (CDP) Setup

## üéØ ¬øQu√© es Segment?

**Segment** es una **Customer Data Platform (CDP)** que act√∫a como **capa de datos unificada** entre tu aplicaci√≥n y todas tus herramientas de analytics y marketing.

### **Arquitectura Actual:**
```
Frontend ‚Üí PostHog
Frontend ‚Üí Clarity
Frontend ‚Üí Customer.io
Frontend ‚Üí (futuros tools...)
```

### **Arquitectura con Segment:**
```
Frontend ‚Üí Segment ‚Üí {PostHog, Clarity, Customer.io, Mixpanel, Amplitude, ...}
```

---

## ‚úÖ Ventajas de Usar Segment

### **1. Single Source of Truth**
- Un solo SDK para todos los destinos
- Eventos consistentes en todas las plataformas
- Menos c√≥digo para mantener

### **2. Flexibilidad**
- Agregar/quitar herramientas sin tocar c√≥digo
- A/B test de analytics platforms
- Cambiar de vendor sin re-deployment

### **3. Data Governance**
- Schema validation centralizado
- Data quality control
- Compliance (GDPR/CCPA) m√°s f√°cil

### **4. Warehouse Integration**
- Enviar datos a BigQuery, Snowflake, Redshift
- Data science y BI avanzados
- Long-term data retention

---

## üîß Implementaci√≥n

### **SDK Instalado:**
```bash
npm install @segment/analytics-next
```

**Paquete:** `packages/analytics`

---

## üìä Funciones Disponibles

### **Inicializaci√≥n:**
```typescript
import { segmentInit } from '@ingeia/analytics';

// Initialize Segment
await segmentInit(writeKey);
```

### **Tracking de Eventos:**
```typescript
import { segmentTrack } from '@ingeia/analytics';

// Track custom event
segmentTrack('Button Clicked', {
  button_name: 'Sign Up',
  page: '/homepage'
});
```

### **Identificaci√≥n de Usuarios:**
```typescript
import { segmentIdentify } from '@ingeia/analytics';

// Identify user
segmentIdentify('user_123', {
  email: 'user@example.com',
  name: 'John Doe',
  plan: 'enterprise'
});
```

### **Tracking de P√°ginas:**
```typescript
import { segmentPage } from '@ingeia/analytics';

// Track page view
segmentPage('/projects', {
  title: 'Projects Dashboard',
  url: window.location.href
});
```

---

## üéØ Integraci√≥n Autom√°tica

### **SPA Screen Tracking:**

El hook `useSpaPageviews()` **ya incluye Segment** autom√°ticamente:

```typescript
// packages/analytics/src/index.ts
export function useSpaPageviews(getUrl: () => string) {
  useEffect(() => {
    const url = getUrl();
    
    // Track in PostHog
    posthog.capture('$pageview', { url });
    
    // Track in Clarity
    if (window.clarity) {
      window.clarity('set', 'page', url);
    }
    
    // Track in Customer.io
    if (window._cio) {
      window._cio.page(url, { url });
    }
    
    // Track in Segment ‚úÖ NEW
    if (window.analytics) {
      segmentPage(url, { url });
    }
  }, [getUrl()]);
}
```

### **Unified Identify:**

La funci√≥n `identify()` **ya incluye Segment**:

```typescript
export function identify(userId: string, props?: Record<string, any>) {
  posthog.identify(userId, props);      // PostHog
  customerioIdentify(userId, props);    // Customer.io
  segmentIdentify(userId, props);       // Segment ‚úÖ NEW
}
```

---

## üöÄ Setup en Segment Dashboard

### **1. Crear Cuenta en Segment**

```
https://app.segment.com/signup
```

### **2. Crear Source (JavaScript)**

1. Dashboard ‚Üí Sources ‚Üí Add Source
2. Seleccionar **JavaScript** (Web)
3. Nombre: "AXSOL.ai Viewer - SITE" (o "WWW")
4. Copiar **Write Key**

### **3. Configurar Destinations**

Segment puede enviar datos a m√∫ltiples destinos:

#### **Opci√≥n A: Destinations Oficiales (Recomendado)**

1. Connections ‚Üí Destinations ‚Üí Add Destination
2. Buscar y agregar:
   - **PostHog**
   - **Customer.io**
   - **Google Analytics 4** (opcional)
   - **Mixpanel** (opcional)
   - **Amplitude** (opcional)

3. Configurar cada destination:
   - **PostHog:** API Key + Host
   - **Customer.io:** Site ID + API Key
   - **GA4:** Measurement ID

#### **Opci√≥n B: Keep Direct Integrations**

Puedes mantener las integraciones directas actuales y usar Segment **adem√°s**:

- PostHog: Direct + Segment (redundant but safe)
- Customer.io: Direct + Segment
- Clarity: Solo Direct (no hay destination en Segment)

---

## üìù Configuraci√≥n de Variables de Entorno

### **SITE** (`apps/site/.env`):
```bash
VITE_SEGMENT_WRITE_KEY=abc123def456xyz789
```

### **WWW** (`apps/www/.env`):
```bash
VITE_SEGMENT_WRITE_KEY=abc123def456xyz789
```

**Nota:** Puedes usar el mismo Write Key para ambas apps o crear sources separados.

---

## üîÑ Estrategias de Migraci√≥n

### **Estrategia 1: Segment como Layer Adicional (Recomendado)**

**Configuraci√≥n Actual:**
- Mantener PostHog directo
- Mantener Customer.io directo
- Mantener Clarity directo
- **Agregar Segment** en paralelo

**Ventajas:**
- ‚úÖ Sin riesgo de perder datos
- ‚úÖ Comparar datos entre direct vs Segment
- ‚úÖ Migraci√≥n gradual

**Implementaci√≥n:**
```bash
# .env
VITE_POSTHOG_KEY=phc_xxx         # Mantener
VITE_CUSTOMERIO_SITE_ID=cio_xxx  # Mantener
VITE_SEGMENT_WRITE_KEY=seg_xxx   # Nuevo
```

---

### **Estrategia 2: Segment como √önica Fuente**

**Configuraci√≥n:**
- Remover PostHog directo
- Remover Customer.io directo
- Mantener Clarity directo (no soportado en Segment)
- **Solo Segment** para todo lo dem√°s

**Ventajas:**
- ‚úÖ Menos c√≥digo
- ‚úÖ Menos dependencias en frontend
- ‚úÖ M√°s f√°cil agregar nuevos tools

**Desventajas:**
- ‚ùå Vendor lock-in a Segment
- ‚ùå Latencia adicional
- ‚ùå Costo de Segment en escala

**Implementaci√≥n:**
```typescript
// packages/analytics/src/index.ts
// Comentar inicializaciones directas

export function analyticsInit() {
  // Solo Segment
  segmentInit(writeKey);
}

export function identify(userId, props) {
  // Solo Segment (destinations configurados en dashboard)
  segmentIdentify(userId, props);
}
```

---

### **Estrategia 3: H√≠brida (Para Producci√≥n)**

- **PostHog:** Mantener directo (product analytics cr√≠tico)
- **Customer.io:** Enviar via Segment (easier management)
- **Nuevos tools:** Via Segment (Mixpanel, Amplitude, etc.)
- **Clarity:** Directo (no hay alternativa)

---

## üìä Eventos a Trackear en Segment

### **Eventos Autom√°ticos (Ya Implementados):**
```typescript
// SPA pageviews
segmentPage('/projects', { url: '...' });

// First visit
segmentTrack('first_visit', {
  app: 'site',
  url: window.location.href
});

// User identification
segmentIdentify('user_123', {
  email: 'user@example.com',
  name: 'John Doe'
});
```

### **Eventos Custom (Por Implementar):**
```typescript
// Onboarding
segmentTrack('Tutorial Started');
segmentTrack('Tutorial Completed', { steps: 5 });

// Projects
segmentTrack('Project Created', {
  project_id: '123',
  project_name: 'My Project'
});

segmentTrack('Project Viewed', {
  project_id: '123',
  duration_seconds: 45
});

// Files
segmentTrack('File Uploaded', {
  file_type: 'ifc',
  file_size_mb: 45.2
});

// Viewer 3D
segmentTrack('3D Viewer Opened', {
  project_id: '123',
  first_time: false
});

// Features
segmentTrack('Feature Used', {
  feature_name: 'mesh_analysis',
  duration_seconds: 30
});
```

---

## üß™ Testing

### **Test 1: Segment Initialization**

```javascript
// En consola del navegador
window.analytics  // Debe existir si Segment est√° cargado

// Verificar m√©todos disponibles
window.analytics.track
window.analytics.identify
window.analytics.page
```

### **Test 2: Track Event**

```javascript
// En consola del navegador
import { segmentTrack } from '@ingeia/analytics';

segmentTrack('Test Event', {
  test: true,
  timestamp: new Date().toISOString()
});

// Verificar en Segment Debugger:
// https://app.segment.com/[workspace]/sources/[source]/debugger
```

### **Test 3: Destination Delivery**

1. **Segment Debugger:** Ver eventos en tiempo real
2. **PostHog:** Verificar que eventos llegan (si configurado como destination)
3. **Customer.io:** Verificar que usuarios se crean/actualizan

---

## üìä Segment Debugger

### **Live Events:**

Dashboard ‚Üí Sources ‚Üí [Tu Source] ‚Üí Debugger

**Ver√°s:**
- Raw events en tiempo real
- Payload completo
- Destinations que recibieron el evento
- Errores de delivery

---

## üí∞ Costos de Segment

### **Plan Free:**
- 1,000 MTUs (Monthly Tracked Users) / mes
- 2 sources
- Unlimited destinations
- Data retention: 30 d√≠as

**Ideal para desarrollo y testing**

### **Plan Team ($120/mes):**
- 10,000 MTUs
- 5 sources
- Advanced features (Replay, Protocols)
- Data retention: 1 a√±o

### **Plan Business ($Custom):**
- Unlimited MTUs
- Warehouse destinations
- Advanced security
- SLA

---

## üéØ Recomendaci√≥n

### **Para AXSOL.ai Viewer:**

**Fase 1: Testing (Ahora)**
```bash
# Usar plan gratuito de Segment
# Mantener integraciones directas
# Configurar Segment en paralelo
# Comparar datos
```

**Fase 2: Migraci√≥n Parcial (1-2 meses)**
```bash
# Migrar Customer.io a via Segment
# Mantener PostHog directo
# Agregar Google Analytics 4 via Segment
# Agregar Mixpanel via Segment (opcional)
```

**Fase 3: Producci√≥n (3+ meses)**
```bash
# Evaluar si Segment aporta valor vs costo
# Decidir: Full Segment vs H√≠brido vs Direct
# Implementar data warehouse (BigQuery) si es necesario
```

---

## üìù Configuraci√≥n de Destinations

### **PostHog via Segment:**

1. Segment Dashboard ‚Üí Destinations ‚Üí Add Destination ‚Üí PostHog
2. Configurar:
   ```
   Project API Key: phc_xxx
   PostHog Instance: https://us.i.posthog.com
   ```
3. Mappings (opcional):
   - `track` ‚Üí PostHog `capture`
   - `identify` ‚Üí PostHog `identify`
   - `group` ‚Üí PostHog `group`

### **Customer.io via Segment:**

1. Segment Dashboard ‚Üí Destinations ‚Üí Add Destination ‚Üí Customer.io
2. Configurar:
   ```
   Site ID: abc123
   API Key: your_api_key
   ```
3. Event Mappings:
   - `first_visit` ‚Üí Customer.io campaign trigger
   - `identify` ‚Üí Create/update customer

---

## üîç Debugging Common Issues

### **Issue 1: `window.analytics` es undefined**

**Causa:** Segment no se inicializ√≥ o fallo la carga

**Soluci√≥n:**
```javascript
// Verificar que VITE_SEGMENT_WRITE_KEY existe
console.log(import.meta.env.VITE_SEGMENT_WRITE_KEY);

// Verificar en Network tab que se carg√≥
// cdn.segment.com/analytics.js
```

### **Issue 2: Eventos no llegan a destinations**

**Causa:** Destination no configurado o evento filtrado

**Soluci√≥n:**
1. Segment Debugger ‚Üí Ver si evento lleg√≥ a Segment
2. Connections ‚Üí Ver si destination est√° enabled
3. Destination settings ‚Üí Ver filters

### **Issue 3: Datos duplicados**

**Causa:** Direct integration + Segment destination

**Soluci√≥n:**
- Opci√≥n A: Desactivar direct integration
- Opci√≥n B: Desactivar Segment destination
- Opci√≥n C: Deduplicar en destino (e.g., PostHog distinct_id)

---

## üìö Recursos

- **Segment Docs:** https://segment.com/docs/
- **JavaScript SDK:** https://segment.com/docs/connections/sources/catalog/libraries/website/javascript/
- **Destinations Catalog:** https://segment.com/catalog/
- **Segment University:** https://segment.com/academy/

---

## üéâ Resumen

| Componente | Estado | Funci√≥n |
|------------|--------|---------|
| **Segment SDK** | ‚úÖ Instalado | `@segment/analytics-next` |
| **Init Function** | ‚úÖ Implementado | `segmentInit()` |
| **Track Function** | ‚úÖ Implementado | `segmentTrack()` |
| **Page Function** | ‚úÖ Implementado | `segmentPage()` |
| **Identify Function** | ‚úÖ Implementado | `segmentIdentify()` |
| **SPA Integration** | ‚úÖ Implementado | Auto-tracking en `useSpaPageviews()` |
| **SITE** | ‚úÖ Configurado | Env var + init |
| **WWW** | ‚úÖ Configurado | Env var + init |
| **Env Variables** | ‚úÖ Documentado | `.env.example` actualizado |

### **Pr√≥ximos Pasos:**
1. [ ] Crear cuenta en Segment
2. [ ] Crear JavaScript source
3. [ ] Copiar Write Key
4. [ ] Configurar `.env` files
5. [ ] Testing en desarrollo
6. [ ] Configurar destinations (PostHog, Customer.io)
7. [ ] Deploy y validar en producci√≥n

¬°Tu CDP est√° listo para unificar todos tus datos! üöÄ
